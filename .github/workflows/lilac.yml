name: lilac
on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:
    inputs:
      lilac_args:
        default: ''
        description: 'Args pass to lilac'
        type: string
jobs:
  lilac:
    runs-on: ubuntu-latest
    steps:
      - name: Check and mount cgroup2
        run: |
          grep cgroup /proc/filesystems
          sudo mount -t cgroup2 none /sys/fs/cgroup
          mount
      - name: Prepare the directory
        run: |
          mkdir -p lilac/gitrepo
          mkdir -p lilac/repo
          mkdir -p lilac/remote
          mkdir -p lilac/config
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: Misaka13514-AUR/repo
          fetch-depth: 0
          ssh-key: ${{ secrets.SSH_KEY }}
          path: lilac/gitrepo
      - name: Write config
        run: |
          umask 077
          echo "${{ secrets.SSH_KEY }}" > lilac/config/ssh_key
          echo "${{ secrets.GPG_KEY }}" > lilac/config/gpg_key
          cat <<'EOF' > lilac/config/rclone.conf
          ${{ secrets.RCLONE_CONFIG }}
          'EOF'
          cp -a lilac/gitrepo/lilac.toml lilac/config/lilac.toml
          sed -i "s|<DB_URL>|${{ secrets.DB_URL }}|g" lilac/config/lilac.toml
          sed -i "s|<SMTP_PASSWORD>|${{ secrets.SMTP_PASSWORD }}|g" lilac/config/lilac.toml
      - name: Start Docker container
        run: |
          docker run --rm -d \
            --name lilac \
            --privileged \
            --cap-add SYS_ADMIN \
            --security-opt seccomp=unconfined \
            --cgroup-parent=docker.slice \
            --cgroupns private \
            --tmpfs /tmp \
            --tmpfs /run \
            --tmpfs /run/lock \
            -v $(pwd)/lilac:/home/lilac/lilac \
            ghcr.io/misaka13514-aur/actions-playground:latest
      - name: Set up system environment in Docker
        run: |
          docker exec -t lilac /init.sh
      - name: Set up user environment in Docker
        run: |
          docker exec -t lilac loginctl enable-linger lilac
          docker exec -t lilac machinectl shell lilac@ \
            /usr/bin/gpg --batch --import lilac/config/gpg_key
      - name: Mount remote directory
        run: |
          docker exec -t lilac machinectl shell lilac@ \
            /usr/bin/rclone mount --daemon --read-only remote: lilac/remote
      - name: Copy lilac persist files from remote
        run: |
          docker exec -t lilac machinectl shell lilac@ \
            /usr/bin/rclone sync -v --exclude-from /rclone-exclude.txt sync remote:lilac .lilac
      # - name: Run lilac
      #   run: |
      #     docker exec -t lilac machinectl shell lilac@ \
      #       /usr/bin/lilac ${{ inputs.lilac_args }}
          ## post process
          # if any pkgs are built, run the following commands
            # repo-add
            # copy packages to remote
            # cleanup old packages
            # attest the packages
          # always run the following commands
            # copy logs to remote
            # copy lilac persist files to remote
            # output logs to summary
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          install-dependencies: true
      - name: Unmount remote directory
        run: |
          docker exec -t lilac machinectl shell lilac@ \
            /usr/bin/fusermount -u lilac/remote
