name: lilac
on:
  workflow_dispatch:
    inputs:
      lilac_args:
        default: ''
        description: 'Args pass to lilac'
        type: string
env:
  GITREPO: git@github.com:Misaka13514-AUR/repo.git
  DOCKER_IMAGE: ghcr.io/misaka13514-aur/actions-playground:latest
  REPO_NAME: apeiria
jobs:
  lilac:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
    steps:
      - name: ğŸ› ï¸ğŸ“‚ Prepare directories
        run: |
          # git repository contains PKGBUILDs
          mkdir -p lilac/gitrepo
          # local temporary directory to store built packages
          mkdir -p lilac/repo
          # remote directory:
          #   - lilac: .lilac persist files
          #   - aur/x86_64: packages and pacman database
          #   - aur/log: build logs
          #   - aur/archive: old packages
          mkdir -p lilac/remote
          # config files
          #   - ssh_key: SSH private key
          #   - gpg_key: GPG private key
          #   - rclone.conf: rclone config
          #   - lilac.toml: lilac config
          mkdir -p lilac/config
      - name: â¬‡ï¸ğŸ™ Clone git repository
        run: |
          echo "${{ secrets.SSH_KEY }}" | install -Dm600 /dev/stdin ~/.ssh/id_ed25519
          git clone --single-branch ${{ env.GITREPO }} lilac/gitrepo
      - name: ğŸ› ï¸ğŸ“ Write configuration
        run: |
          umask 077
          echo "${{ secrets.SSH_KEY }}" > lilac/config/ssh_key
          echo "${{ secrets.GPG_KEY }}" > lilac/config/gpg_key
          echo '${{ secrets.RCLONE_CONFIG }}' > lilac/config/rclone.conf
          cp -a lilac/gitrepo/lilac.toml lilac/config/lilac.toml
          sed -i "s|<DB_URL>|${{ secrets.DB_URL }}|g" lilac/config/lilac.toml
          sed -i "s|<SMTP_PASSWORD>|${{ secrets.SMTP_PASSWORD }}|g" lilac/config/lilac.toml
          sed -i "s|<GITHUB_TOKEN>|${{ secrets.GITHUB_TOKEN }}|g" lilac/config/lilac.toml
          echo "[keys]" >> lilac/config/nvchecker_keyfile.toml
          echo 'github = "${{ secrets.GITHUB_TOKEN }}"' >> lilac/config/nvchecker_keyfile.toml
      - name: ğŸ³âš™ï¸ Setup Docker environment
        run: |
          # https://ubuntu.com/blog/ubuntu-23-10-restricted-unprivileged-user-namespaces
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_unconfined=0
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
          # prepare the docker environment
          # https://docs.docker.com/reference/cli/dockerd/#configure-cgroup-driver
          docker info
          docker pull ${{ env.DOCKER_IMAGE }}
      - name: ğŸ³ğŸš€ Start Docker container
        shell: 'script -q -e -a /dev/null -c "bash {0}"'
        run: |
          docker run --rm -d \
            --name lilac \
            --privileged \
            --cap-add SYS_ADMIN \
            --security-opt seccomp=unconfined \
            --cgroup-parent=docker.slice \
            --cgroupns private \
            --tmpfs /tmp \
            --tmpfs /run \
            --tmpfs /run/lock \
            -v $(pwd)/lilac:/home/lilac/lilac \
            ${{ env.DOCKER_IMAGE }}
      - name: ğŸ³ğŸ“¦ Initialize system environment
        run: |
          docker exec -t lilac /init.sh
      - name: ğŸ³ğŸ‘¤ Setup user environment
        run: |
          docker exec -t lilac loginctl enable-linger lilac
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/gpg --batch --import lilac/config/gpg_key
      - name: ğŸ³ğŸ”—ğŸ—‚ï¸ Mount remote storage
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone mount --daemon remote: lilac/remote
      - name: ğŸ³â¬‡ï¸ğŸ” Download lilac persist files
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone sync -v --exclude-from /rclone-exclude.txt remote:lilac .lilac
      - name: ğŸ³ğŸ¤–ğŸš€ Run lilac
        run: |
          docker exec -t lilac machinectl shell lilac@ \
            /usr/bin/lilac ${{ inputs.lilac_args }}
      - name: ğŸ³â¬†ï¸ğŸ“œ Upload lilac logs
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone copy -v --copy-links .lilac/log remote:aur/log
      - name: ğŸ³â¬†ï¸ğŸ” Upload lilac persist files
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone sync -v --exclude-from /rclone-exclude.txt .lilac remote:lilac
      - name: ğŸ§™ğŸ”ğŸ“œ Print lilac logs
        run: |
          echo "Summary log:"
          docker exec -t lilac cat /home/lilac/.lilac/build.log
          echo ""
          echo "Detailed log:"
          docker exec -t lilac /group-log.sh
      - name: ğŸ“œâ¡ï¸ğŸ“„ Add build log to summary
        run: |
          echo "## Build log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker exec -t lilac cat /home/lilac/.lilac/build.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: ğŸ”¢ğŸ“¦ Count built packages
        id: count
        run: |
          echo "pkgs_count=$(find lilac/repo -type f -name *.pkg.tar.zst | wc -l)" >> $GITHUB_OUTPUT
      - name: âœ…ğŸ“¦ Attest built packages
        if: steps.count.outputs.pkgs_count != 0
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'lilac/repo/*.pkg.tar.zst'
      - name: â¬‡ï¸ğŸ—ƒï¸ Download pacman database
        if: steps.count.outputs.pkgs_count != 0
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone copy -v --copy-links remote:aur/x86_64/${{ env.REPO_NAME }}.db.tar.gz lilac/repo
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone copy -v --copy-links remote:aur/x86_64/${{ env.REPO_NAME }}.db.tar.gz lilac/repo
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone copy -v --copy-links remote:aur/x86_64/${{ env.REPO_NAME }}.files lilac/repo
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone copy -v --copy-links remote:aur/x86_64/${{ env.REPO_NAME }}.files.tar.gz lilac/repo
      - name: ğŸ“¦â¡ï¸ğŸ—ƒï¸ Add packages to database
        if: steps.count.outputs.pkgs_count != 0
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/repo-add lilac/repo/${{ env.REPO_NAME }}.db.tar.gz lilac/repo/*.pkg.tar.zst
          rm -f lilac/repo/${{ env.REPO_NAME }}.db.tar.gz.old
          rm -f lilac/repo/${{ env.REPO_NAME }}.files.tar.gz.old
      - name: â¬†ï¸ğŸ“¦âœï¸ğŸ—ƒï¸ Upload packages and database
        if: steps.count.outputs.pkgs_count != 0
        run: |
          docker exec -t lilac sudo -iu lilac \
            /usr/bin/rclone copy -v --copy-links lilac/repo/ remote:aur/x86_64
      - name: ğŸ’©â¡ï¸ğŸš½ Clean up
        if: steps.count.outputs.pkgs_count != 0
        run: |
          docker exec -t lilac sudo -iu lilac \
            /repocleaner.py
      - name: ğŸ› Setup tmate session
        if: always()
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          install-dependencies: true
